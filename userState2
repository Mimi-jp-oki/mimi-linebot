const userStates = {}; // ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã”ã¨ã®çŠ¶æ…‹ä¿å­˜
const stressQuestions = [
  "æœ€è¿‘ã€æ°—åˆ†ãŒæ™´ã‚Œãªã„ã“ã¨ãŒå¤šã„ã§ã™ã‹ï¼Ÿ",
  "è·å ´ã§ã‚¤ãƒ©ã‚¤ãƒ©ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã‹ï¼Ÿ",
  "ä½“ã®ã ã‚‹ã•ã‚’æ„Ÿã˜ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã‹ï¼Ÿ",
  "å¯ã¤ããŒæ‚ªã„ã€ã¾ãŸã¯é€”ä¸­ã§ç›®ãŒè¦šã‚ã¾ã™ã‹ï¼Ÿ",
  "å‘¨å›²ã‹ã‚‰ã®ã‚µãƒãƒ¼ãƒˆï¼ˆä¸Šå¸ãƒ»åŒåƒšï¼‰ã‚’æ„Ÿã˜ã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ",
  "è‡ªåˆ†ã®ä»•äº‹ãŒã†ã¾ãã„ã£ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ",
  "ä¸å®‰æ„ŸãŒå¼·ã„ã¨æ„Ÿã˜ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
  "ç–²åŠ´ãŒè“„ç©ã—ã¦ã„ã‚‹ã¨æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ",
  "ä»Šã®ä»•äº‹ã«æº€è¶³ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
  "ç›¸è«‡ã§ãã‚‹ç›¸æ‰‹ãŒã„ã¾ã™ã‹ï¼Ÿ"
];
ãã—ã¦ã€handleEvent ã®ä¸­ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ç®¡ç†ğŸ‘‡

if (!userStates[userId]) {
  // åˆå›ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨
  userStates[userId] = { step: 0, score: 0, inProgress: false };
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’ã—ãŸã„ã€ã¨è¨€ã£ãŸã‚‰é–‹å§‹
if (event.message.text.includes("ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯")) {
  userStates[userId].step = 0;
  userStates[userId].score = 0;
  userStates[userId].inProgress = true;

  return client.replyMessage(event.replyToken, {
    type: 'text',
    text: `Q1: ${stressQuestions[0]}ï¼ˆã¯ã„ï¼ã„ã„ãˆï¼‰`
  });
}

// å›ç­”ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡¦ç†
if (userStates[userId].inProgress) {
  const step = userStates[userId].step;
  const answer = event.message.text;

  // ã€Œã¯ã„ã€ã®å ´åˆ1ç‚¹
  if (answer.includes("ã¯ã„")) {
    userStates[userId].score += 1;
  }

  userStates[userId].step += 1;

  if (userStates[userId].step < stressQuestions.length) {
    const nextQuestion = stressQuestions[userStates[userId].step];
    return client.replyMessage(event.replyToken, {
      type: 'text',
      text: `Q${userStates[userId].step + 1}: ${nextQuestion}ï¼ˆã¯ã„ï¼ã„ã„ãˆï¼‰`
    });
  } else {
    // çµ‚äº†æ™‚ï¼šã‚¹ã‚³ã‚¢ã‚’åˆ¤å®š
    const score = userStates[userId].score;
    let result = "";

    if (score <= 2) result = "ã‚¹ãƒˆãƒ¬ã‚¹åº¦ï¼šä½ï¼ˆè‰¯å¥½ãªçŠ¶æ…‹ã§ã™ï¼ï¼‰";
    else if (score <= 5) result = "ã‚¹ãƒˆãƒ¬ã‚¹åº¦ï¼šä¸­ï¼ˆå°‘ã—ç–²ã‚ŒãŒè¦‹ã‚‰ã‚Œã¾ã™ï¼‰";
    else result = "ã‚¹ãƒˆãƒ¬ã‚¹åº¦ï¼šé«˜ï¼ˆé«˜ã‚¹ãƒˆãƒ¬ã‚¹çŠ¶æ…‹ã€‚ã‚±ã‚¢ãŒå¿…è¦ã§ã™ï¼‰";

    // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
    userStates[userId] = { step: 0, score: 0, inProgress: false };

    return client.replyMessage(event.replyToken, {
      type: 'text',
      text: `ã‚¹ãƒˆãƒ¬ã‚¹ãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼\nã‚ãªãŸã®ã‚¹ã‚³ã‚¢ï¼š${score}ç‚¹\n${result}`
    });
  }
}
